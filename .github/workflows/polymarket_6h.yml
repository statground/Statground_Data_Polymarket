name: Polymarket (every 6h) - crawl to ClickHouse (UTC)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours (UTC)

concurrency:
  group: polymarket-6h-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # Optional PAT (for org-wide access). If empty, scripts fall back to GITHUB_TOKEN.
      GH_TOKEN: ${{ secrets.POLYMARKET_PAT }}

      # Polymarket API base
      POLY_BASE: https://gamma-api.polymarket.com

      # GitHub repo info (checkpoint is written to this repo)
      ORG: statground
      ORCHESTRATOR_REPO: Statground_Data_Polymarket
      DEFAULT_BRANCH: main

      # ClickHouse (store as repo secrets)
      CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
      CLICKHOUSE_PORT: ${{ secrets.CLICKHOUSE_PORT }}
      CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_USER }}
      CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_PASSWORD }}
      CLICKHOUSE_DATABASE: ${{ secrets.CLICKHOUSE_DATABASE }}
      # http (8123) or native (9000). If your 40011 is HTTP, set interface=http.
      CLICKHOUSE_INTERFACE: ${{ secrets.CLICKHOUSE_INTERFACE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Crawl to ClickHouse
        env:
          # Actions token always exists; scripts fall back to this if GH_TOKEN is empty.
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          python scripts/polymarket_crawl_to_clickhouse.py
