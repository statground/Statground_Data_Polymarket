name: Polymarket (hourly) - daily crawl (UTC) + hourly stats (single workflow)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour (UTC)

concurrency:
  group: polymarket-hourly
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.POLYMARKET_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run hourly scheduler (crawl once per UTC day; stats every hour)
        env:
          # GitHub
          GH_PAT: ${{ secrets.POLYMARKET_PAT }}
          ORG: statground
          ORCHESTRATOR_REPO: Statground_Data_Polymarket
          REPO_PREFIX: Statground_Data_Polymarket
          DEFAULT_BRANCH: main

          # Scheduler
          SCHED_STATE_PATH: .state/polymarket_scheduler.json
          CRAWL_ONCE_PER_UTC_DAY: "true"

          # Crawl
          POLY_BASE: https://gamma-api.polymarket.com
          PAGE_LIMIT: "100"
          MAX_PAGES: "200"
          ORDER_PRIMARY: updatedAt
          ORDER_FALLBACK: id
          OUT_ROOT: by_created
          CHECKPOINT_PATH: .state/polymarket_checkpoint.json

          # Fan-out counts file (written into each year repo)
          COUNTS_FILE_NAME: POLYMARKET_COUNTS.json

          # Stats output (written into orchestrator via API)
          STATS_MD_PATH: POLYMARKET_REPO_STATS.md
        run: |
          python scripts/polymarket_hourly_scheduler.py
